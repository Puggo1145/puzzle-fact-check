<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Fact Check API Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        #app {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .input-section, .output-section {
            flex: 1;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 600px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .event-log {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .event-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .event-extract-start {
            background-color: #e3f2fd;
        }
        .event-extract-end {
            background-color: #e1f5fe;
        }
        .event-evaluate-start {
            background-color: #fff8e1;
        }
        .event-evaluate-end {
            background-color: #fffde7;
        }
        .event-report-start {
            background-color: #e8f5e9;
        }
        .event-report-end {
            background-color: #f1f8e9;
        }
        .event-decision {
            background-color: #f3e5f5;
        }
        .event-error {
            background-color: #ffebee;
        }
        .event-feedback {
            background-color: #e0f7fa;
        }
        .event-wait {
            background-color: #ede7f6;
        }
        .feedback-section {
            display: none;
            padding: 15px;
            background-color: #e8eaf6;
            border-radius: 4px;
            margin-top: 15px;
        }
        .show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Puzzle Fact Check API Demo</h1>
    <div id="app">
        <div class="container">
            <div class="input-section">
                <h2>è¾“å…¥æ–°é—»æ–‡æœ¬</h2>
                <textarea id="news-text" placeholder="åœ¨æ­¤è¾“å…¥éœ€è¦æ ¸æŸ¥çš„æ–°é—»æ–‡æœ¬...">æœ€è¿‘æœ‰ç½‘ç»œæµä¼ è¯´æ³•ç§°ï¼Œ2025 å¹´åˆï¼Œç¾å›½å…±å’Œå…šè®®å‘˜Riley Mooreé€šè¿‡äº†ä¸€é¡¹æ–°æ³•æ¡ˆï¼Œå°†ç¦æ­¢ä¸­å›½å…¬æ°‘ä»¥å­¦ç”Ÿèº«ä»½æ¥ç¾å›½ã€‚è¿™é¡¹æ³•æ¡ˆä¼šå¯¼è‡´æ¯å¹´å¤§çº¦30ä¸‡ä¸­å›½å­¦ç”Ÿå°†æ— æ³•è·å¾—Fã€Jã€Mç±»ç­¾è¯ï¼Œä»è€Œæ— æ³•åˆ°ç¾å›½å­¦ä¹ æˆ–å‚ä¸å­¦æœ¯äº¤æµã€‚</textarea>
                <div>
                    <button id="create-agent-btn">åˆ›å»º Agent</button>
                    <button id="start-btn" disabled>å¼€å§‹æ ¸æŸ¥</button>
                </div>
            </div>
            <div class="output-section">
                <h2>äº‹ä»¶æ—¥å¿—</h2>
                <div class="event-log" id="event-log"></div>
            </div>
        </div>
        <div>
            <h2>æœ€ç»ˆæŠ¥å‘Š</h2>
            <pre id="final-report"></pre>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€
        const state = {
            sessionId: null,
            eventSource: null,
            isRunning: false,
            events: []
        };

        // DOM å…ƒç´ 
        const newsTextArea = document.getElementById('news-text');
        const createAgentBtn = document.getElementById('create-agent-btn');
        const startBtn = document.getElementById('start-btn');
        const eventLog = document.getElementById('event-log');
        const finalReport = document.getElementById('final-report');

        // API åŸºç¡€ URL - æ ¹æ®å®é™…éƒ¨ç½²æƒ…å†µä¿®æ”¹
        const API_BASE_URL = 'http://localhost:8000/api';

        // åˆ›å»º Agent
        createAgentBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/agents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_name: 'gpt-4o',
                        model_provider: 'openai'
                    })
                });
                
                const data = await response.json();
                state.sessionId = data.session_id;
                
                addEventToLog({
                    event: 'agent_created',
                    data: { message: `Agent åˆ›å»ºæˆåŠŸ: ${state.sessionId}` }
                });
                
                startBtn.disabled = false;
                createAgentBtn.disabled = true;
                
                // å¼€å§‹ç›‘å¬ SSE äº‹ä»¶
                startEventStream();
                
            } catch (error) {
                console.error('åˆ›å»º Agent å¤±è´¥:', error);
                addEventToLog({
                    event: 'error',
                    data: { message: `åˆ›å»º Agent å¤±è´¥: ${error.message}` }
                });
            }
        });

        // å¼€å§‹æ ¸æŸ¥
        startBtn.addEventListener('click', async () => {
            if (!state.sessionId) {
                alert('è¯·å…ˆåˆ›å»º Agent');
                return;
            }
            
            const newsText = newsTextArea.value.trim();
            if (!newsText) {
                alert('è¯·è¾“å…¥éœ€è¦æ ¸æŸ¥çš„æ–°é—»æ–‡æœ¬');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/agents/${state.sessionId}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        news_text: newsText
                    })
                });
                
                const data = await response.json();
                
                state.isRunning = true;
                startBtn.disabled = true;
                
                addEventToLog({
                    event: 'run_started',
                    data: { message: 'å¼€å§‹æ‰§è¡Œæ ¸æŸ¥æµç¨‹' }
                });
                
            } catch (error) {
                console.error('å¯åŠ¨æ ¸æŸ¥å¤±è´¥:', error);
                addEventToLog({
                    event: 'error',
                    data: { message: `å¯åŠ¨æ ¸æŸ¥å¤±è´¥: ${error.message}` }
                });
            }
        });

        // å¼€å§‹ SSE äº‹ä»¶æµ
        function startEventStream() {
            if (state.eventSource) {
                state.eventSource.close();
            }
            
            state.eventSource = new EventSource(`${API_BASE_URL}/agents/${state.sessionId}/events`);
            
            // å¿ƒè·³äº‹ä»¶ - ä¿æŒè¿æ¥
            state.eventSource.addEventListener('heartbeat', (event) => {
                // console.log('å¿ƒè·³äº‹ä»¶:', JSON.parse(event.data));
            });
            
            // æå–æ ¸æŸ¥ç‚¹äº‹ä»¶
            state.eventSource.addEventListener('extract_check_point_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_check_point_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('extract_check_point_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_check_point_end',
                    data: data
                });
            });
            
            // å…ƒæ•°æ®æå–ä»£ç†äº‹ä»¶
            state.eventSource.addEventListener('extract_basic_metadata_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_basic_metadata_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('extract_basic_metadata_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_basic_metadata_end',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('extract_knowledge_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_knowledge_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('extract_knowledge_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'extract_knowledge_end',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('retrieve_knowledge_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'retrieve_knowledge_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('retrieve_knowledge_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'retrieve_knowledge_end',
                    data: data
                });
            });
            
            // æœç´¢ä»£ç†äº‹ä»¶
            state.eventSource.addEventListener('search_agent_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'search_agent_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('evaluate_status_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'evaluate_status_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('status_evaluation_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'status_evaluation_end',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('tool_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'tool_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('tool_result', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'tool_result',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('generate_answer_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'generate_answer_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('generate_answer_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'generate_answer_end',
                    data: data
                });
            });
            
            // è¯„ä¼°æ£€ç´¢ç»“æœäº‹ä»¶
            state.eventSource.addEventListener('evaluate_search_result_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'evaluate_search_result_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('evaluate_search_result_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'evaluate_search_result_end',
                    data: data
                });
            });
            
            // æ’°å†™æŠ¥å‘Šäº‹ä»¶
            state.eventSource.addEventListener('write_fact_checking_report_start', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'write_fact_checking_report_start',
                    data: data
                });
            });
            
            state.eventSource.addEventListener('write_fact_checking_report_end', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'write_fact_checking_report_end',
                    data: data
                });
                
                // æ˜¾ç¤ºæœ€ç»ˆæŠ¥å‘Š
                finalReport.textContent = data.report;
            });
            
            // LLM å†³ç­–äº‹ä»¶
            state.eventSource.addEventListener('llm_decision', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'llm_decision',
                    data: data
                });
            });
            
            // ä»»åŠ¡å®Œæˆäº‹ä»¶
            state.eventSource.addEventListener('task_complete', (event) => {
                const data = JSON.parse(event.data);
                
                addEventToLog({
                    event: 'task_complete',
                    data: data
                });
                
                state.isRunning = false;
                createAgentBtn.disabled = false;
                startBtn.disabled = true;
            });
            
            // é”™è¯¯äº‹ä»¶
            state.eventSource.addEventListener('error', (event) => {
                console.error('SSE é”™è¯¯:', event);
                
                if (event.data) {
                    try {
                        const data = JSON.parse(event.data);
                        addEventToLog({
                            event: 'error',
                            data: data
                        });
                    } catch (e) {
                        addEventToLog({
                            event: 'error',
                            data: { message: 'SSE è§£æé”™è¯¯: ' + (event.data || 'æœªçŸ¥é”™è¯¯') }
                        });
                    }
                } else {
                    addEventToLog({
                        event: 'error',
                        data: { message: 'SSE è¿æ¥é”™è¯¯' }
                    });
                }
                
                // å°è¯•é‡æ–°è¿æ¥
                setTimeout(() => {
                    if (state.isRunning) {
                        startEventStream();
                    }
                }, 3000);
            });
        }

        // æ·»åŠ äº‹ä»¶åˆ°æ—¥å¿—
        function addEventToLog(eventObj) {
            state.events.push(eventObj);
            
            const eventItem = document.createElement('div');
            eventItem.className = `event-item event-${eventObj.event}`;
            
            // æ ¹æ®äº‹ä»¶ç±»å‹è®¾ç½®å†…å®¹
            let content = '';
            switch (eventObj.event) {
                case 'agent_created':
                case 'run_started':
                    content = `<strong>${eventObj.data.message}</strong>`;
                    break;
                    
                case 'extract_check_point_start':
                    content = `<strong>ğŸ§  LLM å¼€å§‹æå–æ ¸æŸ¥ç‚¹</strong>`;
                    break;
                    
                case 'extract_check_point_end':
                    content = `<strong>âœ… æå–æ ¸æŸ¥ç‚¹å®Œæˆ</strong>`;
                    if (eventObj.data.check_points && eventObj.data.check_points.items) {
                        const checkPoints = eventObj.data.check_points.items;
                        content += `<p>å…±æ‰¾åˆ° ${checkPoints.length} ä¸ªæ ¸æŸ¥ç‚¹</p>`;
                        checkPoints.forEach((cp, idx) => {
                            if (cp.is_verification_point) {
                                content += `<p><strong>æ ¸æŸ¥ç‚¹ ${idx+1}:</strong> ${cp.content}</p>`;
                                content += `<p><strong>æ ¸æŸ¥ç†ç”±:</strong> ${cp.importance}</p>`;
                                if (cp.retrieval_step && cp.retrieval_step.length > 0) {
                                    content += `<p><strong>æ£€ç´¢è®¡åˆ’:</strong></p>`;
                                    cp.retrieval_step.forEach((step, stepIdx) => {
                                        content += `<p>- è®¡åˆ’ ${stepIdx+1}: ${step.purpose}</p>`;
                                    });
                                }
                            }
                        });
                    }
                    break;
                
                // å…ƒæ•°æ®æå–ä»£ç†äº‹ä»¶æ˜¾ç¤º
                case 'extract_basic_metadata_start':
                    content = `<strong>ğŸ” å¼€å§‹æå–æ–°é—»åŸºæœ¬å…ƒæ•°æ®</strong>`;
                    break;
                
                case 'extract_basic_metadata_end':
                    content = `<strong>âœ… æå–æ–°é—»åŸºæœ¬å…ƒæ•°æ®å®Œæˆ</strong>`;
                    if (eventObj.data.basic_metadata) {
                        const metadata = eventObj.data.basic_metadata;
                        content += `<p><strong>æ–°é—»ç±»å‹:</strong> ${metadata.news_type || 'æœªçŸ¥'}</p>`;
                        content += `<p><strong>æ ‡é¢˜:</strong> ${metadata.title || 'æœªçŸ¥'}</p>`;
                        content += `<p><strong>æ—¶é—´:</strong> ${metadata.time || 'æœªçŸ¥'}</p>`;
                    }
                    break;
                
                case 'extract_knowledge_start':
                    content = `<strong>ğŸ” å¼€å§‹æå–çŸ¥è¯†å…ƒç´ </strong>`;
                    break;
                
                case 'extract_knowledge_end':
                    content = `<strong>âœ… æå–çŸ¥è¯†å…ƒç´ å®Œæˆ</strong>`;
                    if (eventObj.data.knowledges && eventObj.data.knowledges.length) {
                        content += `<p>å…±æ‰¾åˆ° ${eventObj.data.knowledges.length} ä¸ªçŸ¥è¯†å…ƒç´ </p>`;
                    }
                    break;
                
                case 'retrieve_knowledge_start':
                    content = `<strong>ğŸ” å¼€å§‹æ£€ç´¢çŸ¥è¯†å…ƒç´ å®šä¹‰</strong>`;
                    break;
                
                case 'retrieve_knowledge_end':
                    content = `<strong>âœ… æ£€ç´¢çŸ¥è¯†å…ƒç´ å®šä¹‰å®Œæˆ</strong>`;
                    if (eventObj.data.retrieved_knowledge) {
                        const knowledge = eventObj.data.retrieved_knowledge;
                        content += `<p><strong>æœ¯è¯­:</strong> ${knowledge.term || 'æœªçŸ¥'}</p>`;
                        content += `<p><strong>å®šä¹‰:</strong> ${knowledge.definition || 'æœªçŸ¥'}</p>`;
                    }
                    break;
                
                // æœç´¢ä»£ç†äº‹ä»¶æ˜¾ç¤º
                case 'search_agent_start':
                    content = `<strong>ğŸ” æœç´¢ä»£ç†å¼€å§‹æ‰§è¡Œ</strong>`;
                    content += `<p><strong>æ ¸æŸ¥å†…å®¹:</strong> ${eventObj.data.content}</p>`;
                    content += `<p><strong>æ£€ç´¢ç›®çš„:</strong> ${eventObj.data.purpose}</p>`;
                    break;
                
                case 'evaluate_status_start':
                    content = `<strong>ğŸ¤” ${eventObj.data.message}</strong>`;
                    break;
                
                case 'status_evaluation_end':
                    content = `<strong>âœ… æœç´¢çŠ¶æ€è¯„ä¼°å®Œæˆ</strong>`;
                    if (eventObj.data.status) {
                        const status = eventObj.data.status;
                        content += `<p><strong>è¯„ä¼°:</strong> ${status.evaluation}</p>`;
                        content += `<p><strong>ä¸‹ä¸€æ­¥:</strong> ${status.next_step}</p>`;
                    }
                    break;
                
                case 'tool_start':
                    content = `<strong>ğŸ› ï¸ å¼€å§‹ä½¿ç”¨å·¥å…·:</strong> ${eventObj.data.tool_name}`;
                    content += `<p><strong>è¾“å…¥:</strong> ${eventObj.data.input}</p>`;
                    break;
                
                case 'tool_result':
                    content = `<strong>âœ… å·¥å…·è°ƒç”¨ç»“æœ:</strong>`;
                    content += `<p>${eventObj.data.output}</p>`;
                    break;
                
                case 'generate_answer_start':
                    content = `<strong>ğŸ§  ${eventObj.data.message}</strong>`;
                    break;
                
                case 'generate_answer_end':
                    content = `<strong>âœ… ç”Ÿæˆæœç´¢ç»“è®ºå®Œæˆ</strong>`;
                    if (eventObj.data.result) {
                        const result = eventObj.data.result;
                        content += `<p><strong>ç»“è®º:</strong> ${result.conclusion}</p>`;
                        content += `<p><strong>ä¿¡å¿ƒ:</strong> ${result.confidence}</p>`;
                    }
                    break;
                    
                case 'evaluate_search_result_start':
                    content = `<strong>ğŸ§  LLM å¼€å§‹è¯„ä¼°æ£€ç´¢ç»“æœ</strong>`;
                    break;
                    
                case 'evaluate_search_result_end':
                    content = `<strong>âœ… è¯„ä¼°æ£€ç´¢ç»“æœå®Œæˆ</strong>`;
                    if (eventObj.data.verification_result) {
                        const vr = eventObj.data.verification_result;
                        content += `<p><strong>éªŒè¯ç»“æœ:</strong> ${vr.verified ? 'é€šè¿‡' : 'æœªé€šè¿‡'}</p>`;
                        content += `<p><strong>æ¨ç†è¿‡ç¨‹:</strong> ${vr.reasoning}</p>`;
                    }
                    break;
                    
                case 'write_fact_checking_report_start':
                    content = `<strong>ğŸ§  LLM å¼€å§‹æ’°å†™æ ¸æŸ¥æŠ¥å‘Š</strong>`;
                    break;
                    
                case 'write_fact_checking_report_end':
                    content = `<strong>âœ… æ’°å†™æ ¸æŸ¥æŠ¥å‘Šå®Œæˆ</strong>`;
                    break;
                    
                case 'llm_decision':
                    content = `<strong>ğŸ§  LLM åšå‡ºå†³ç­–:</strong> ${eventObj.data.decision}`;
                    if (eventObj.data.reason) {
                        content += `<p>å†³ç­–ç†ç”±: ${eventObj.data.reason}</p>`;
                    }
                    break;
                    
                case 'task_complete':
                    content = `<strong>ğŸ‰ ä»»åŠ¡å®Œæˆ:</strong> ${eventObj.data.message}`;
                    break;
                    
                case 'error':
                    content = `<strong>âŒ é”™è¯¯:</strong> ${eventObj.data.message || JSON.stringify(eventObj.data)}`;
                    break;
                    
                default:
                    content = `<strong>${eventObj.event}:</strong> ${JSON.stringify(eventObj.data)}`;
            }
            
            eventItem.innerHTML = content;
            eventLog.appendChild(eventItem);
            eventLog.scrollTop = eventLog.scrollHeight;
        }
    </script>
</body>
</html> 