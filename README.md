# Puzzle: A graph-based self-reflective AI news fact-checking agent
A research project from Nova news AI. Puzzle 使用一个主推理模型作为全局事实陈述提取、任务规划和推理的核心，使用多个子模型根据主模型规划的任务进行自主网络检索，并使用图谱存储和更新证据，最终生成可解释的推理过程和结论。主模型将根据当前推理状态和证据图谱，动态调整检索策略和推理路径，实现自我修正和持续优化，最终生成高质量的核查结论

采用 LangGraph 进行工作流编排，实现了模块化、低耦合、高内聚的架构设计。系统由主推理引擎、专家子模型集群、知识图谱管理器和工具集成层组成，通过状态管理和事件驱动机制实现各组件间的协调与通信。

# Built with
- LangGraph
- LangChain
- Browser-use
- Neo4j

# 项目结构

```
puzzle/
├── core/                      # 核心系统组件
│   ├── engine.py              # 主推理引擎
│   ├── state_manager.py       # 状态管理器
│   ├── event_bus.py           # 事件总线
│   └── config.py              # 系统配置
├── models/                    # 模型定义
│   ├── base_model.py          # 模型基类
│   ├── main_reasoner.py       # 主推理模型
│   └── experts/               # 专家模型
│       ├── data_expert.py     # 数据验证专家
│       ├── history_expert.py  # 历史事件专家
│       ├── person_expert.py   # 人物关系专家
│       └── science_expert.py  # 科学事实专家
├── knowledge/                 # 知识图谱管理
│   ├── graph_manager.py       # 图谱管理器
│   ├── schema.py              # 图谱模式定义
│   ├── node_types.py          # 节点类型定义
│   └── relation_types.py      # 关系类型定义
├── tools/                     # 工具集成
│   ├── tool_registry.py       # 工具注册中心
│   ├── base_tool.py           # 工具基类
│   ├── search/                # 搜索工具
│   │   ├── google_search.py   # Google搜索
│   │   └── bing_search.py     # Bing搜索
│   ├── browser/               # 浏览器工具
│   │   ├── browser_tool.py    # 浏览器操作
│   │   └── content_parser.py  # 内容解析
│   └── data/                  # 数据工具
│       ├── statistics_tool.py # 统计分析
│       └── chart_parser.py    # 图表解析
├── workflows/                 # LangGraph工作流
│   ├── main_workflow.py       # 主工作流定义
│   ├── verification_flow.py   # 验证工作流
│   └── reflection_flow.py     # 反思工作流
├── states/                    # 状态定义
│   ├── base_state.py          # 状态基类
│   ├── verification_state.py  # 验证状态
│   └── reasoning_state.py     # 推理状态
├── utils/                     # 工具函数
│   ├── token_counter.py       # Token计数器
│   ├── logger.py              # 日志工具
│   └── prompt_templates.py    # 提示模板
├── api/                       # API接口
│   ├── routes.py              # 路由定义
│   └── controllers.py         # 控制器
├── tests/                     # 测试代码
│   ├── unit/                  # 单元测试
│   └── integration/           # 集成测试
├── config/                    # 配置文件
│   ├── default.yaml           # 默认配置
│   └── production.yaml        # 生产配置
├── main.py                    # 应用入口
└── README.md                  # 项目说明
```

# 检索时精简
### 证据分层架构

**Level 1 (核心层)**
- 仅包含直接支持/反驳陈述的1-2个关键句子
- 必须包含明确的逻辑关系标记

**Level 2 (上下文层)**
- 包含核心证据的必要上下文(2-3句)
- 仅在主推理模型请求时加载

**Level 3 (完整证据)**
- 存储为外部URL引用
- 仅在特殊情况下访问 

### 证据优先级机制

为每条证据分配一个综合评分(0-10)，基于：
- 相关性：证据与陈述的直接相关程度(0-3)
- 可靠性：来源的权威性和可信度(0-3)
- 时效性：信息的时间贴近度(0-2)
- 独特性：提供的独特信息价值(0-2)

主推理将优先考虑评分≥7的证据，其他证据仅在必要时考虑。 

### 语义压缩表示

采用高效的证据表示方法：

1. **实体规范化**：使用唯一ID代替重复出现的实体名称
   - 示例：将"美国总统拜登"替换为Entity[P001]

2. **关系编码**：使用简洁代码表示证据与陈述的关系
   - S+: 强力支持
   - S-: 弱支持
   - N: 中性/无关
   - C-: 弱反驳
   - C+: 强力反驳

3. **证据模板化**：使用结构化模板存储常见证据类型
   - 数值型证据：[Entity] [数值关系] [数值±误差] [单位] [时间点]
   - 事件型证据：[行为主体] [行为] [客体] [时间] [地点] 

### 证据合并与去重

1. **相似度聚类**：使用语义相似度(≥85%)识别相似证据
2. **多源合并**：合并来自不同来源的相似证据，保留所有来源引用
3. **强度累积**：记录支持同一论点的来源数量，提升可信度
4. **冲突标记**：显式标记来自不同来源但内容矛盾的证据 

### 增量检索与按需扩展

1. **基础-扩展模式**：
   - 基础阶段：对每个陈述仅检索1-2条核心证据
   - 扩展阶段：仅针对有争议或证据不足的陈述进行深度检索

2. **检索停止条件**：
   - 达到证据饱和(多个可靠来源一致确认)
   - 发现明确反例
   - 达到预设检索深度上限 

# 整体框架优化方案
### 任务规划与资源分配

1. **动态资源分配**
   - 根据陈述的重要性、复杂性和不确定性动态调整分配的检索资源
   - 对社会影响大、涉及重要人物或敏感话题的陈述分配更多检索资源

2. **子任务优先级队列**
   - 使用多因素评分模型为检索任务排序
   - 允许随时调整优先级，响应新发现的关键信息 

### 子模型专业化

1. **专业化检索模型**
   - 数据验证专家：专注于数字、统计、趋势等数据类型核查
   - 历史事件专家：专注于历史事件、时间线和因果关系核查
   - 人物关系专家：专注于人物背景、关系网络和行为模式核查
   - 科学事实专家：专注于科学原理、研究发现和技术知识核查

2. **协作与知识共享机制**
   - 子模型间建立发现共享通道，允许一个子模型利用另一个子模型的发现
   - 实现"知识广播"机制，重要发现自动通知所有相关子模型 

### 知识图谱结构增强

1. **时间敏感图谱**
   - 每个节点和关系添加时间属性：事件发生时间、报道时间、验证时间
   - 支持时间线视图，追踪事件和信息演变

2. **不确定性表示**
   - 使用概率权重表示关系的确定性(0.0-1.0)
   - 明确区分"未验证"和"已证伪"节点
   
3. **多维度关系**
   - 支持复合关系类型，包含：逻辑关系、时间关系、空间关系等
   - 实现关系的元属性，描述关系本身的特性

### 反思与自我修正机制

1. **决策点记录**
   - 记录每个重要推理步骤和证据选择
   - 构建决策树，支持回溯和替代路径探索

2. **假设测试**
   - 主动生成与当前结论相反的假设
   - 专门分配资源验证这些假设，增强结论可靠性

3. **失败模式库**
   - 维护常见检索和推理失败模式
   - 对照检查当前任务是否符合已知失败模式

### 系统效率优化

1. **证据缓存与复用**
   - 建立证据缓存机制，相似陈述可复用已验证的证据
   - 设置时效性标志，定期更新时效性敏感的缓存

2. **批量处理**
   - 识别相关陈述集合，一次性检索相关证据
   - 优化检索查询，一次检索满足多个相关陈述的需求

3. **并行检索管道**
   - 无依赖关系的检索任务并行执行
   - 实现检索结果流式处理，边检索边更新图谱

### 工具使用智能化

1. **工具选择与调用优化**
   - 为每个工具维护效能指标(准确率、延迟、token消耗)
   - 基于历史效能数据，智能选择最适合当前任务的工具
   - 支持工具组合调用模式，解决复杂检索需求

2. **查询优化**
   - 自动生成多样化检索查询，覆盖不同表达和角度
   - 实现查询结果分析与查询重构反馈循环

### 最终输出优化

1. **多层次结论呈现**
   - 简明摘要：1-2句核心结论
   - 详细解释：支持/反驳的主要证据及推理路径
   - 完整分析：全部证据、不确定因素和置信度分析

2. **可解释性增强**
   - 生成决策依据图，明确展示哪些证据影响了最终结论
   - 提供替代解释，说明若某些证据不可靠时可能的不同结论

